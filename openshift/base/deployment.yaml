apiVersion: apps/v1
kind: Deployment
metadata:
  name: parsec
  annotations:
    image.openshift.io/triggers: >-
      [{"from":{"kind":"ImageStreamTag","name":"parsec:latest"},"fieldPath":"spec.template.spec.containers[?(@.name==\"parsec\")].image"},{"from":{"kind":"ImageStreamTag","name":"parsec:latest"},"fieldPath":"spec.template.spec.initContainers[?(@.name==\"seed-pricing\")].image"},{"from":{"kind":"ImageStreamTag","name":"parsec:latest"},"fieldPath":"spec.template.spec.initContainers[?(@.name==\"seed-azure-billing\")].image"}]
spec:
  replicas: 1
  selector:
    matchLabels:
      app: parsec
      component: api
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 0
      maxSurge: 1
  template:
    metadata:
      labels:
        app: parsec
        component: api
    spec:
      serviceAccountName: parsec-oauth
      securityContext:
        runAsNonRoot: true
        seccompProfile:
          type: RuntimeDefault
      initContainers:
        - name: seed-pricing
          image: parsec:latest
          command: ["sh", "-c", "cp /app/data-seed/ec2_pricing.json /app/data/ec2_pricing.json"]
          volumeMounts:
            - name: pricing-cache
              mountPath: /app/data
          securityContext:
            allowPrivilegeEscalation: false
            runAsNonRoot: true
            capabilities:
              drop:
                - ALL
            seccompProfile:
              type: RuntimeDefault
        - name: seed-azure-billing
          image: parsec:latest
          command: ["python3", "scripts/refresh_azure_billing.py", "--init-only"]
          volumeMounts:
            - name: pricing-cache
              mountPath: /app/data
          securityContext:
            allowPrivilegeEscalation: false
            runAsNonRoot: true
            capabilities:
              drop:
                - ALL
            seccompProfile:
              type: RuntimeDefault
      containers:
        - name: parsec
          image: parsec:latest
          ports:
            - containerPort: 8000
              name: http
              protocol: TCP
          env:
            - name: PARSEC_ANTHROPIC__BACKEND
              value: "vertex"
            - name: PARSEC_ANTHROPIC__VERTEX_PROJECT_ID
              value: "itpc-gcp-product-all-claude"
            - name: PARSEC_ANTHROPIC__VERTEX_REGION
              value: "us-east5"
            - name: PARSEC_ANTHROPIC__VERTEX_CREDENTIALS_PATH
              value: "/app/gcp/service-account.json"
            - name: PARSEC_PROVISION_DB__HOST
              valueFrom:
                secretKeyRef:
                  name: parsec-secrets
                  key: db-host
            - name: PARSEC_PROVISION_DB__PORT
              value: "54327"
            - name: PARSEC_PROVISION_DB__DATABASE
              valueFrom:
                secretKeyRef:
                  name: parsec-secrets
                  key: db-name
            - name: PARSEC_PROVISION_DB__USER
              valueFrom:
                secretKeyRef:
                  name: parsec-secrets
                  key: db-user
            - name: PARSEC_PROVISION_DB__PASSWORD
              valueFrom:
                secretKeyRef:
                  name: parsec-secrets
                  key: db-password
            - name: PARSEC_AWS__REGION
              value: "us-east-1"
            - name: PARSEC_GCP__CREDENTIALS_PATH
              value: "/app/gcp-billing/service-account.json"
            - name: PARSEC_AUTH__ALLOWED_USERS
              valueFrom:
                configMapKeyRef:
                  name: parsec-allowed-users
                  key: allowed-users
                  optional: true
          envFrom:
            - secretRef:
                name: parsec-cloud-credentials
                optional: true
          volumeMounts:
            - name: config
              mountPath: /app/config/config.yaml
              subPath: config.yaml
              readOnly: true
            - name: vertex-credentials
              mountPath: /app/gcp
              readOnly: true
            - name: gcp-billing-credentials
              mountPath: /app/gcp-billing
              readOnly: true
            - name: reports
              mountPath: /app/reports
            - name: pricing-cache
              mountPath: /app/data
          resources:
            requests:
              memory: "256Mi"
              cpu: "100m"
            limits:
              memory: "512Mi"
              cpu: "500m"
          securityContext:
            allowPrivilegeEscalation: false
            runAsNonRoot: true
            capabilities:
              drop:
                - ALL
            seccompProfile:
              type: RuntimeDefault
          livenessProbe:
            httpGet:
              path: /api/health
              port: 8000
            initialDelaySeconds: 15
            periodSeconds: 30
            timeoutSeconds: 5
          readinessProbe:
            httpGet:
              path: /api/health/ready
              port: 8000
            initialDelaySeconds: 10
            periodSeconds: 10
            timeoutSeconds: 5
          startupProbe:
            httpGet:
              path: /api/health
              port: 8000
            initialDelaySeconds: 10
            periodSeconds: 10
            failureThreshold: 12
      volumes:
        - name: config
          configMap:
            name: parsec-config
        - name: vertex-credentials
          secret:
            secretName: vertex-credentials
            defaultMode: 0400
        - name: gcp-billing-credentials
          secret:
            secretName: gcp-billing-credentials
            defaultMode: 0400
            optional: true
        - name: reports
          emptyDir: {}
        - name: pricing-cache
          persistentVolumeClaim:
            claimName: parsec-pricing-cache
